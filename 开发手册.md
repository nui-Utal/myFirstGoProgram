# æ–°å¶å®˜ç½‘â€”â€”ä»0åˆ°1çš„go/giné¡¹ç›®å¼€å‘

åŒ… =ã€‹æ•°æ®åº“/è¡¨ =ã€‹è·¯ç”±æ³¨å†Œ =ã€‹ä¸­é—´ä»¶ =ã€‹å¤„ç†å‡½æ•° =ã€‹è¡¨æ“ä½œ

ä¸­é—´ä»¶æœ‰å¿…è¦åœ¨å¤„ç†å‡½æ•°ä¹‹å‰ï¼Œå·²ç™»å½•çš„ç”¨æˆ·ç›¸å…³ä¿¡æ¯ä»è§£æçš„tokenä¿¡æ¯ä¸­è·å¾—æ›´å®‰å…¨ã€‚åœ¨handlersä¸­é‡åˆ°éœ€è¦è¿›è¡Œè¡¨æ“ä½œçš„æ—¶å€™å†å»å†™daoã€‚

**åŒ…ç»“æ„æ€è·¯ï¼š**

1. å¤§ç»“æ„ï¼š

   - æœ€å¤–å±‚main.go
   - pkg *åç«¯ä»£ç *
     - router
     - middleware
     - handler
     - modelsâ€¦â€¦
   - web *å‰ç«¯ä»£ç *
   - config
   - web â€¦â€¦

2. å°ç»“æ„ï¼šï¼ˆpkgï¼‰

   - modelsï¼šè¡¨+ç›¸å…³è¡¨æ“ä½œ
   - routerï¼šè·¯ç”±
   - handlerï¼šå¤„ç†è¯·æ±‚
   - commonï¼šæ•°æ®å®¹å™¨æˆ–è€…å…±åŒçš„æ–¹æ³•ï¼ˆä¸Šä¼ å›¾ç‰‡ç­‰ï¼‰(éœ€è¦ä¼ å…¥*gin.Context)
   - utils

   è¿™æ˜¯ginçš„å®˜æ–¹æ–‡æ¡£ä¸­çš„æ¡ˆä¾‹ï¼Œæˆ‘ä½¿ç”¨æ³¨é‡Šè¿›è¡Œåˆ†å±‚ï¼Œå¹¶æŒ‰ç…§å¯¹åº”ç»“æ„åˆ›å»ºäº†åŒ…ï¼š

   ```go
   func main() {
       r := gin.Default()
       // route ----------
   	r.GET("/ping", func(c *gin.Context) {
           // service  -------------
   		c.JSON(200, gin.H{
   			"message": "pong",
   		})
   	})
   	r.Run()
   }
   ```

   äºæ˜¯ mainï¼š

   ```go
   func main() {
   	router := routers.InitRoute()
   	router.Run(":8080")
   }
   ```

   routerï¼š

   ```go
   func InitRoute() *gin.Engine {
   	r := gin.Default()
   	r.GET("/index", service.GetIndex)
   
   	return r
   }
   ```

   serviceï¼š

   ```go
   func GetIndex(ctx *gin.Context) {
   	ctx.JSON(200, gin.H{
   		"ms": "welcome!!",
   	})
   }
   ```


å¤šå±‚çš„åº”ç”¨å¯ä»¥ä½¿ç”¨åˆ«åï¼š

`common2 "xinyeOfficalWebsite/pkg/common"`



å¤§é¡¹ç›®é¡¹ç›®ç»“æ„å¯ä»¥å‚è€ƒï¼š

```go
- cmd
  - yourappname    // å­˜æ”¾åº”ç”¨ç¨‹åºçš„å…¥å£æ–‡ä»¶
- internal         // å­˜æ”¾å†…éƒ¨åŒ…å’Œæ¨¡å—ï¼Œä¸å¯¹å¤–æš´éœ²
  - pkg1           // å†…éƒ¨åŒ…1
  - pkg2           // å†…éƒ¨åŒ…2
- pkg              // å­˜æ”¾å¯å¯¼å‡ºçš„åŒ…ï¼Œä¾›å…¶ä»–é¡¹ç›®ä½¿ç”¨
- api              // å­˜æ”¾APIç›¸å…³çš„å®šä¹‰å’Œå®ç°
  - handler        // å¤„ç†APIè¯·æ±‚çš„å¤„ç†å™¨
  - middleware     // å­˜æ”¾ä¸­é—´ä»¶
  - models         // å­˜æ”¾æ•°æ®æ¨¡å‹
- config           // å­˜æ”¾é…ç½®æ–‡ä»¶
- scripts          // å­˜æ”¾é¡¹ç›®ç›¸å…³çš„è„šæœ¬æ–‡ä»¶
- test             // å­˜æ”¾æµ‹è¯•æ–‡ä»¶
```

**ç›¸å…³åº“**ï¼ˆä¸€äº›è¦go getçš„éƒ¨åˆ†ï¼‰

- ç½‘ç»œï¼ˆginæ¡†æ¶ï¼‰

  go get -u github.com/gin-gonic/gin

- æ•°æ®åº“ç›¸å…³ï¼ˆgormæ¡†æ¶ï¼‰

  gorm.io/gorm

- ç”µè¯å·ç /é‚®ç®±æ ¡éªŒ

  go get github.com/asaskevich/govalidator

- redis

  github.com/go-redis/redis/v8

- è¯»å–é…ç½®

  github.com/spf13/viper

- å‹ç¼©å›¾ç‰‡

  github.com/nfnt/resize

- æ–‡æœ¬è¿‡æ»¤

  github.com/google/go-html-sanitizer

- mysqlæµ‹è¯•

  go get github.com/DATA-DOG/go-sqlmock

- â€¦â€¦

## è¡¨è®¾è®¡

éå¤§å‹é¡¹ç›®ï¼Œ**è¡¨è®¾è®¡çš„æ—¶å€™ä¸€ç›´åœ¨åšå‡æ³•**

åŸºæœ¬å†…å®¹ï¼šæ™®é€šç”¨æˆ·ç™»å½•ï¼Œå…³æ³¨ã€å–å…³ç”¨æˆ·ï¼ŒæŸ¥çœ‹ã€è¯„è®ºã€åˆ é™¤æ–‡ç« /å¸–å­ï¼Œåå°ç”¨æˆ·ç™»å½•ä¸ç›¸å…³æŸ¥çœ‹

åŸºæœ¬è¡¨ï¼š

- ç”¨æˆ·è¡¨

- æ–‡ç« /å¸–å­ã€Š== åœ¨å‘ç°ä¸¤å¼ è¡¨å­—æ®µå®Œå…¨ç›¸åŒåˆå¹¶åˆ°åŒä¸€å¼ è¡¨ï¼Œä½¿ç”¨typeåŒºåˆ†

- å…³æ³¨å…³ç³»è¡¨

- è¯„è®ºè¡¨

- å›å¤è¡¨ï¼ˆparentidè®¾ç½®ä¸ºå¤–é”®ï¼Œç»‘å®šuseridä¸èƒ½ä¸ºç©ºï¼Œéœ€è¦å¦ç½®ï¼‰

- å–œæ¬¢ï¼ˆlikeï¼‰è¡¨ + æ”¶è—è¡¨

  ä¸¤å¼ è¡¨ä¹Ÿå¯ä»¥æ•´åˆä½†æ˜¯å‰åå†™çš„æ—¶é—´æ¯”è¾ƒé•¿äºæ˜¯æ²¡æ³¨æ„åˆ°

- ç®¡ç†å‘˜è¡¨

- è½®æ’­å›¾çš„è¡¨

ä¸€äº›ç»†èŠ‚

- å¤–é”®å‘½åï¼š`fk_curtable_relatable`ï¼Œåœ¨åç»­ä¿®æ”¹ä¸­ååˆ†å®ç”¨

  æ³¨æ„éƒ¨åˆ†å­—æ®µåœ¨åˆ é™¤æ—¶çš„å…³è”åˆ é™¤æˆ–æ˜¯ç½®ä¸ºç©º

- è®¾ç½®é‡è¦å­—æ®µå†…å®¹ä¸ä¸ºç©º

- å¤§éƒ¨åˆ†çš„è¡¨çš„idéœ€è¦è®¾ç½®ä¸ºè‡ªåŠ¨é€’å¢

  åœ¨ç»“æ„ä½“ä¸­ç±»å‹å¯ä»¥è®¾ç½®ä¸ºuintï¼ˆæ— ç¬¦å·æ•´æ•°ï¼‰ï¼Œå¹¶éœ€è¦æ·»åŠ ï¼š`gorm:"primaryKey;autoIncrement"`

- å­—æ®µå€¼çš„ä¸å¯é‡å¤ï¼šåœ¨ç´¢å¼•ä¸­é€‰æ‹©ç´¢å¼•ç±»å‹å”¯ä¸€



****************

å‰è¨€ç»“æŸï¼Œæ­£å¼è¿›å…¥å¼€å‘ğŸ˜

## é…ç½®ç›¸å…³

### åŸºæœ¬é…ç½®æ–‡ä»¶

config.yaml

```yml
redis:	# æ³¨æ„åˆ†å·åçš„ç©ºæ ¼
  addr: localhost:6379
  password: ""
  DB: 0
  poolSize: 30
  minIdleConn: 30
```

### è¯»å–é…ç½®æ–‡ä»¶

1. `go get github.com/spf13/viper`
2. ç¼–å†™å‡½æ•°ç»‘å®šå¯¹åº”çš„é…ç½®æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶å

å£°æ˜å…¨å±€å˜é‡ï¼ˆåªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡ï¼‰

```go
var (
	DB  *gorm.DB
	Rdb *redis.Client
)
```

1. ç»‘å®šå¯¹åº”çš„é…ç½®æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶å
2. è¯»å–
3. è¯»å–çš„é”™è¯¯å¤„ç†ï¼šè®°å½•åˆ°æ—¥å¿—å*ç›´æ¥è¿”å›*
4. æ—¥å¿—è¾“å‡º

```go
func InitConfig() {
	viper.SetConfigName("website")
	viper.AddConfigPath("config")

	if err := viper.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); ok {
			// Config file not found; ignore error if desired
			log.Println("no such config file")
		} else {
			// Config file was found but another error was produced
			log.Println("read config error")
		}
		log.Fatal(err)
		return
	}
	fmt.Println("config file inited......")
}
```

### åˆå§‹åŒ–mysql

1. åˆ›å»ºå¯¹åº”çš„æ—¥å¿—å˜é‡

   ```go
   newLogger := logger.New(
   		log.New(os.Stdout, "\r\n", log.LstdFlags),	// æ ‡å‡†è¾“å‡ºï¼Œåˆ†éš”ç¬¦ï¼Œè¾“å‡ºæ—¶é—´æ—¥æœŸ
   		logger.Config{
   			SlowThreshold: time.Second, // æ…¢sqlé˜ˆå€¼ï¼ˆæ‰§è¡Œæ—¶é—´è¶…è¿‡è¿™ä¸ªå€¼çš„sqlä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸­ï¼‰
   			LogLevel:      lgger.Info,	// æ—¥å¿—çº§åˆ«
   			Colorful:      true,	// å½©è‰²
   		})
   ```

2. åœ¨é“¾æ¥æ•°æ®åº“æ—¶è®¾ç½®

   ```go
   	DB, _ = gorm.Open(mysql.Open(viper.GetString("mysql.dsn")),
   		&gorm.Config{Logger: newLogger})
   ```

>*Debug*ï¼ˆè°ƒè¯•ï¼‰: Debug çº§åˆ«çš„æ—¥å¿—ä¸»è¦ç”¨äºè°ƒè¯•ç›®çš„ï¼Œè®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ã€‚è¿™äº›æ—¥å¿—é€šå¸¸åŒ…å«å˜é‡å€¼ã€å‡½æ•°è°ƒç”¨å †æ ˆç­‰è¯¦ç»†ä¿¡æ¯ï¼Œæœ‰åŠ©äºå¼€å‘äººå‘˜å®šä½å’Œè§£å†³é—®é¢˜ã€‚
>
>*Info*ï¼ˆä¿¡æ¯ï¼‰: Info çº§åˆ«çš„æ—¥å¿—ç”¨äºè®°å½•ä¸€èˆ¬çš„ä¿¡æ¯æ€§æ¶ˆæ¯ã€‚è¿™äº›æ¶ˆæ¯ä¸æ¶‰åŠé”™è¯¯æˆ–å¼‚å¸¸æƒ…å†µï¼Œä½†æä¾›äº†å…³é”®æ€§çš„è¿è¡ŒçŠ¶æ€æˆ–è¿›ç¨‹ä¸­çš„é‡è¦äº‹ä»¶ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜è¿›è¡Œè·Ÿè¸ªå’Œç›‘è§†ã€‚
>
>*Warn*ï¼ˆè­¦å‘Šï¼‰: Warn çº§åˆ«çš„æ—¥å¿—ç”¨äºè®°å½•å¯èƒ½ä¼šå¯¼è‡´æ½œåœ¨é—®é¢˜çš„éè‡´å‘½æ€§è­¦å‘Šã€‚è¿™äº›è­¦å‘Šä¿¡æ¯ä¸ä¼šä¸­æ–­ä»£ç æ‰§è¡Œï¼Œä½†å¯èƒ½å­˜åœ¨æ½œåœ¨çš„é—®é¢˜ï¼Œéœ€è¦å¼€å‘äººå‘˜æ³¨æ„ã€‚
>
>*Error*ï¼ˆé”™è¯¯ï¼‰: Error çº§åˆ«çš„æ—¥å¿—ç”¨äºè®°å½•é”™è¯¯å’Œå¼‚å¸¸æƒ…å†µã€‚è¿™äº›æ—¥å¿—è¡¨ç¤ºä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†ä¸ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢ã€‚å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®è¿™äº›æ—¥å¿—ä¿¡æ¯æ¥è¿›è¡Œé”™è¯¯è¯Šæ–­å’Œä¿®å¤ã€‚
>
>*Fatal*ï¼ˆè‡´å‘½ï¼‰: Fatal çº§åˆ«çš„æ—¥å¿—ç”¨äºè®°å½•ä¸¥é‡çš„é”™è¯¯æƒ…å†µï¼Œè¡¨ç¤ºç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œã€‚ä¸€æ—¦å‘ç”Ÿè‡´å‘½é”™è¯¯ï¼Œç¨‹åºå°†ç«‹å³åœæ­¢è¿è¡Œã€‚é€šå¸¸åœ¨è‡´å‘½é”™è¯¯åéœ€è¦è¿›è¡Œç´§æ€¥å¤„ç†ã€‚

### åˆå§‹åŒ–redis

1. åˆ›å»ºredisçš„å®¢æˆ·ç«¯
2. ä½¿ç”¨pingæµ‹è¯•redisæ˜¯å¦è¿æ¥æˆåŠŸ

```go
	Rdb = redis.NewClient(&redis.Options{
		Addr:         viper.GetString("redis.addr"),
		Password:     viper.GetString("redis.password"),
		DB:           viper.GetInt("redis.DB"),
		PoolSize:     viper.GetInt("redis.poolSize"),
		MinIdleConns: viper.GetInt("redis.minIdleConn"),
	})
	Rctx := context.Background()
	pong, err := Rdb.Ping(Rctx).Result()
	if err != nil {
		fmt.Println("init redis ...", err)
		return
	}
	fmt.Println("redis inited...... ", pong)
```

æœ€åï¼Œåœ¨main.goä¸­è°ƒç”¨åˆå§‹åŒ–å‡½æ•°



## route

1. æ™®é€šè·¯ç”±

   ```go
   r := gin.Default()
   r.POST("/request/path", handlerFunc)	// r.è¯·æ±‚æ–¹å¼("", å¤„ç†å‡½æ•°ï¼Œå‚æ•°å¿…é¡»æ˜¯*gin.Context)
   ```

   > gin.New ä¸ gin.Default
   >
   > - gin.New ä¸­Useçš„é¡ºåºå°±æ˜¯ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåº
   > - gin.Default ä¸­é»˜è®¤å¼€å¯äº†Logger å’Œ Recovery ä¸­é—´ä»¶ï¼Œè‡ªä¸»å®šä¹‰çš„ä¸­é—´ä»¶éƒ½ä¼šåœ¨è¿™ä¹‹åæ‰§è¡Œ

2. ä¸­é—´ä»¶

   1. å±€éƒ¨

      ```go
      auth := r.Group("/", middleware)
      {
          // è¢«ä¿æŠ¤çš„è·¯ç”±
      }
      ```

   2. å…¨å±€

      ```go
      r.Use(middlewares.CorsMiddleware) // è·¨åŸŸè¯·æ±‚
      ```





## ä¸­é—´ä»¶

### é™æ€èµ„æºæ˜ å°„

- `router.StaticFS("/static", http.FS(static.EmbedStatic))`ï¼šé€‚ç”¨äºå°†é™æ€æ–‡ä»¶åµŒå…¥åˆ°åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå¹¶ä»åµŒå…¥çš„æ–‡ä»¶ç³»ç»Ÿæä¾›æœåŠ¡ã€‚
- `router.Static("/static", "./static")`ï¼šé€‚ç”¨äºä»ç£ç›˜ä¸Šçš„æŒ‡å®šç›®å½•æä¾›é™æ€æ–‡ä»¶æœåŠ¡ã€‚

### è·¨åŸŸå¤„ç†

```go
func Cors(context *gin.Context) {
	method := context.Request.Method
	// å¿…é¡»ï¼Œæ¥å—æŒ‡å®šåŸŸçš„è¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨*ä¸åŠ ä»¥é™åˆ¶ï¼Œä½†ä¸å®‰å…¨
	//context.Header("Access-Control-Allow-Origin", "*")
	context.Header("Access-Control-Allow-Origin", context.GetHeader("Origin"))
	fmt.Println(context.GetHeader("Origin"))
	// å¿…é¡»ï¼Œè®¾ç½®æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•
	context.Header("Access-Control-Allow-Methods", "POST, GET, PUT, DELETE, OPTIONS")
	// æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µï¼Œä¸é™äºæµè§ˆå™¨åœ¨"é¢„æ£€"ä¸­è¯·æ±‚çš„å­—æ®µ
	context.Header("Access-Control-Allow-Headers", "Content-Type, Content-Length, Token")
	// å¯é€‰ï¼Œè®¾ç½®XMLHttpRequestçš„å“åº”å¯¹è±¡èƒ½æ‹¿åˆ°çš„é¢å¤–å­—æ®µ
	context.Header("Access-Control-Expose-Headers", "Access-Control-Allow-Headers, Token")
	// å¯é€‰ï¼Œæ˜¯å¦å…è®¸åç»­è¯·æ±‚æºå¸¦è®¤è¯ä¿¡æ¯Cookirï¼Œè¯¥å€¼åªèƒ½æ˜¯trueï¼Œä¸éœ€è¦åˆ™ä¸è®¾ç½®
	context.Header("Access-Control-Allow-Credentials", "true")
	// æ”¾è¡Œæ‰€æœ‰OPTIONSæ–¹æ³•
	if method == "OPTIONS" {
		context.AbortWithStatus(http.StatusNoContent)
		return
	}
	context.Next()
}
```

### ç™»å½•+

é€šè¿‡è®¾ç½®tokenå®ç°ï¼Œç”±äºæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜éƒ½éœ€è¦åœ¨æŸäº›è¯·æ±‚ä¸Šè¿›è¡Œèº«ä»½éªŒè¯ï¼Œäºæ˜¯è®¾ç½®äº†ä¸åŒçš„endï¼ˆç«¯ï¼‰ï¼Œåœ¨æ·»åŠ å’Œè§£ætokenæ—¶ï¼Œä¼ å…¥å¯¹åº”çš„å‰/åç«¯å­—ç¬¦ä¸²ã€‚

#### 1ã€è®¾ç½®token

ä½¿ç”¨BeareréªŒè¯

- å®šä¹‰å¸¸é‡ `secretKey`

- è‡ªå®šä¹‰äº†Claimsï¼Œè®¾ç½®äº†tokenå‘è¡Œäººï¼Œå¾ˆæ–¹ä¾¿çš„ä¸¤ç§ä¼ å…¥claimsçš„æ–¹å¼ï¼š

  ```go
  // 1ã€
  	claims := Claims{
  		Userid: userid,
  		StandardClaims: jwt.StandardClaims{
  			// è¿‡æœŸæ—¶é—´
  			ExpiresAt: expirationTime,
  			// æŒ‡å®štokenå‘è¡Œäºº
  			Issuer: "xinye_2022",
  		},
  	}
  	token := jwt.NewWithClaims(jwt.SigningMethodHS256, Claims)	// å¯¹ç§°åŠ å¯†
  // 2ã€
  	token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{        
  		"userid": userid,
  		"exp":    expirationTime, // è®¾ç½®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´
  	})
  ```

- ä½¿ç”¨`c.SetCookie()`å°†ä»¤ç‰Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²åæ·»åŠ åˆ°cookieä¸­ã€‚å“åº”åæµè§ˆå™¨ä¼šä¿å­˜cookieåˆ°æœ¬åœ°

  ```go
  	c.SetCookie("remember_me_token", "Bearer "+tokenClaims, int(expirationTime), "/", "", false, true)
  ```

#### 2ã€è§£ætoken

```go
// æ ¹æ®ä¼ å…¥çš„tokenå€¼è·å–åˆ°Claimså¯¹è±¡ä¿¡æ¯ï¼Œï¼ˆè¿›è€Œè·å–å…¶ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ï¼‰
func ParseToken(token, end string) (*Claims, error) {
	//ç”¨äºè§£æé‰´æƒçš„å£°æ˜ï¼Œæ–¹æ³•å†…éƒ¨ä¸»è¦æ˜¯å…·ä½“çš„è§£ç å’Œæ ¡éªŒçš„è¿‡ç¨‹ï¼Œæœ€ç»ˆè¿”å›*Token
	t := strings.Split(token, " ")
	tokenClaims, err := jwt.ParseWithClaims(t[1], &Claims{}, func(token *jwt.Token) (interface{}, error) {
		var signingKey []byte
		switch end {
		case "user":
			signingKey = []byte(user_key)
		case "admin":
			signingKey = []byte(admin_key)
		}
		return signingKey, nil
	})
	if tokenClaims != nil {
		// ä»tokenClaimsä¸­è·å–åˆ°Claimså¯¹è±¡ï¼Œå¹¶ä½¿ç”¨æ–­è¨€ï¼Œå°†è¯¥å¯¹è±¡è½¬æ¢ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Claims
		// è¦ä¼ å…¥æŒ‡é’ˆï¼Œé¡¹ç›®ä¸­ç»“æ„ä½“éƒ½æ˜¯ç”¨æŒ‡é’ˆä¼ é€’ï¼ŒèŠ‚çœç©ºé—´ã€‚
		if claims, ok := tokenClaims.Claims.(*Claims); ok && tokenClaims.Valid {
			return claims, nil
		}
	}
	return nil, err
}
```



#### 3ã€éªŒè¯token

ä¸»è¦åœ¨ä¸­é—´ä»¶å®Œæˆã€‚å…ˆåˆ¤æ–­è¯·æ±‚å¤´ï¼Œåœ¨åˆ¤æ–­è§£æçš„tokenæ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆä¸æ‰§è¡Œåç»­çš„å¤„ç†å‡½æ•°(`c.Abort()`)ï¼Œå½“ç„¶è¿™æ®µä»£ç ä¸èƒ½ç›´æ¥ä½œä¸ºä¸­é—´ä»¶ä½¿ç”¨ï¼Œä¸ä»…å› ä¸ºå‚æ•°ä¸åŒ¹é…ï¼Œè€Œä¸”åœ¨é€šè¿‡åä¸å¯¼å‘ä¸‹ä¸€ä¸ªå¤„ç†å‡½æ•°/ä¸­é—´ä»¶(`c.Next()`)

```go
func AuthenticateToken(c *gin.Context, end string) {
	tokenString := c.GetHeader("Authorization")
	if tokenString == "" {
		c.AbortWithStatus(http.StatusUnauthorized) // å¦‚æœæ²¡æœ‰æä¾›ä»¤ç‰Œï¼Œåˆ™è¿”å›æœªæˆæƒçŠ¶æ€ç 
	}
	claims, err := common.ParseToken(tokenString, end)
	if err != nil {
		common.HandleError(c, http.StatusUnauthorized, "è¯·ç™»å½•åé‡è¯•")
		c.Abort()
	}
	c.Set("user", claims.Userid)
}
```



## handlers

å¤„ç†å‡½æ•°çš„åŸºæœ¬ç»“æ„æˆ–è€…è¯´æ•´ä½“çš„ç¼–å†™æ€è·¯ä¸ºï¼šè·å–å‚æ•°ã€é€»è¾‘å¤„ç†åŠ æŸ¥è¡¨ã€è¿”å›ä¿¡æ¯

### è·å–å‚æ•°

- getï¼š

  - `c.query("name")`ï¼Œå¾—åˆ°stringç±»å‹çš„å€¼ã€‚å¯èƒ½éœ€è¦ç”¨åˆ° `int, err := strconv.Atoi(s)`
  - è¯·æ±‚çš„urlï¼š`/request/path?name=xx`
  - c.Param("id")ï¼Œå¾—åˆ°stringç±»å‹çš„å€¼ã€‚
  - æ³¨å†Œè·¯ç”±æ—¶çš„urlï¼š`/request/:id`ï¼Œè¯·æ±‚çš„urlï¼š`/request/2`

- postï¼š

  - c.PostFrom("key")ï¼Œåªèƒ½ç”¨äºè·å–è¡¨å•çš„æ•°æ®

  - c.DefaultPostForm("username", "default username")ï¼Œè·å–è¡¨å•æ•°æ®å¦‚æœä¸å­˜åœ¨è¿”å›é»˜è®¤å€¼

  - c.ShouldBind(&structVar)ï¼Œç»‘å®šç»“æ„ä½“ï¼Œéœ€è¦ä¼ å…¥ç»“æ„ä½“æŒ‡é’ˆï¼Œä½†è·å–jsonæ•°æ®è¦æ±‚ç»“æ„ä½“åœ¨éœ€è¦ç»‘å®šçš„å˜é‡é¦–å­—æ¯å¤§å°å¹¶è¿›è¡Œå£°æ˜ï¼šeg. Id int \`json:"id"`

    è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºè·å–è¯·æ±‚ä½“ä¸­çš„jsonæ•°æ®

- ä»ä¸Šä¸‹æ–‡ä¸­è·å–å‚æ•°

  - c.Get("key")ï¼Œå½“ç„¶è·å–çš„å‰ææ˜¯å­˜æ”¾ï¼šc.Set("user", uid)

æˆ‘æ‹¿åˆ°çš„é¡¹ç›®apipostæ–‡æ¡£åªæœ‰è¿™ä¸¤ä¸ªæ–¹æ³•çš„è¯·æ±‚ï¼Œäºæ˜¯ä¹Ÿåªåœ¨è¿™é‡Œç»™å‡ºå¸¸ç”¨çš„è·å–å‚æ•°çš„æ–¹å¼

### è¿”å›ä¿¡æ¯

å¸¸ç”¨çš„æˆåŠŸä¿¡æ¯å’Œå¼‚å¸¸å¤„ç†è¢«æˆ‘å¤„ç†ä¸ºå‡½æ•°ï¼Œè¿›è¡Œè°ƒç”¨

```go
func HandleError(c *gin.Context, wro int, ms string) {
	c.JSON(wro, gin.H{
		"code": 404,
		"mes":  ms,
		"data": "",
	})
}

func Success(c *gin.Context, ms string, data interface{}) {
	c.JSON(http.StatusOK, gin.H{
		"code": 200,
		"mes":  ms,
		"data": data,
	})
}
```

dataæœ‰æ—¶ç›´æ¥ä¼ å…¥æŸ¥è¯¢ç»“æœï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›ä¸å¸Œæœ›è¢«ä¼ é€’çš„ä¿¡æ¯æˆ–è€…éœ€è¦æ·»åŠ çš„ä¿¡æ¯ï¼Œå‰è€…åƒuserä¿¡æ¯çš„å¤„ç†ï¼Œæˆ‘å®šä¹‰äº†ç›¸å…³çš„ç»“æ„ä½“å¹¶åœ¨å“åº”æ—¶ä¼ å…¥èµ‹å€¼åçš„ç»“æ„ä½“å˜é‡ï¼›è€Œå¤„ç†åè€…æˆ‘é€‰æ‹©åœ¨è°ƒç”¨Successæ–¹æ³•æ—¶ï¼Œä¼ å…¥ä¸€ä¸ªä¸´æ—¶åˆ›å»ºçš„mapï¼Œæ¯”å¦‚ï¼š

```go
	common.Success(c, "", map[string]interface{}{
		"followed": models.IsFollowed(id, curID),
		"userinfo": common.UserConversion(user),
	})
```

ä½†åœ¨åç»­çš„é¡¹ç›®å¼€å‘ä¸­æˆ‘æ„è¯†åˆ°goè®¾è®¡äº† `gin.H{}` ä¸ºæˆ‘ä»¬ç®€åŒ–äº†è¿™ä¸ªéƒ¨åˆ†ï¼š`map[string]interface{}`

### ä¸­é—´éƒ¨åˆ†

#### ä¸Šä¼ å›¾ç‰‡

1. è§£æè¡¨å•ï¼Œæ£€æŸ¥æ–‡ä»¶å¤§å°

   ```go
   err := c.Request.ParseMultipartForm(32 << 20)
   if err != nil { ... }
   ```

2. é€šè¿‡å‚æ•°åå¾—åˆ°å›¾ç‰‡æ–‡ä»¶

   ```go
   file, hander, err := c.Request.FromFile("paramName")
   if err != nil { ... }
   defer file.Close()	// æ³¨æ„å…³é—­å›¾ç‰‡
   ```

3. æ£€æŸ¥æ–‡ä»¶å­˜æ”¾ä½ç½®

   ```go
   _, err = os.Stat(savePath)	// è·¯å¾„çŠ¶æ€æ£€æŸ¥
   if os.IsNotExist(err) {	// å°†errä¸æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨å¼‚å¸¸ç›¸åŒ¹é…ï¼ˆå¯èƒ½ä¼šå­˜åœ¨å…¶ä»–å¼‚å¸¸æ‰€æœ‰ä¸ç›´æ¥åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼‰
       if err = os.MKdirAll(savePath, 0755); err != nil { .. }
       // åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå³ä½¿æ˜¯å¤šå±‚æ–‡ä»¶ä¹Ÿèƒ½æ­£å¸¸åˆ›å»º
   }
   ```

4. è§£ç åŸå§‹å›¾ç‰‡

   ```go
   imge, _, err := image.Decode(file)	// è§£æä»è¯·æ±‚ä¸­è·å–çš„å›¾ç‰‡æ–‡ä»¶ï¼ŒDecodeè¿”å›å›¾ç‰‡å˜é‡ï¼Œæ–‡ä»¶åï¼Œå¼‚å¸¸
   if err != nil { ... }
   ```

5. åˆ›å»º

   ```go
   dst, err := os.Create(savePath + filename) 
   if err != nil { ... }
   ```

6. ä¿å­˜

   ```go
   fileExt := strings.ToLower(path.Ext(handler))	// å¾—åˆ°æ–‡ä»¶æ‰©å±•åå¹¶å°å†™
   // é€šè¿‡æ‹“å±•åé€‰ç”¨ä¸åŒçš„ä¿å­˜æ–¹æ³•
   	switch fileExt {
   	case ".png":
   		err = png.Encode(dst, image)
   	case ".jpg", ".jpeg":
   		err = jpeg.Encode(dst, image, nil)
   	default:
   		HandleError(c, http.StatusOK, "è¯·ä¸Šä¼ jpg(jpeg)æˆ–pngæ ¼å¼çš„å›¾ç‰‡")
   		return
   	}
   if err != nil { ... }
   ```

   jpngä¸pngéƒ½å¯ä»¥ä½¿ç”¨ `image.Decode` è§£æä½†æ˜¯ä»–ä»¬çš„ä¿å­˜æ–¹æ³•æ˜¯ä¸åŒçš„

#### ä¸Šä¼ æ–‡ç« 

æ³¨æ„éœ€è¦å¯¹ä¸Šä¼ å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼Œé¿å…æ¶æ„ä»£ç å¯¹æ•°æ®åº“é€ æˆå½±å“

```go
col.Content = utils.FilterHTML(col.Content)

var p *bluemonday.Policy = bluemonday.UGCPolicy()

func FilterHTML(input string) string {
	// è¿‡æ»¤ä¸å—ä¿¡ä»»çš„ HTML
	sanitizedInput := p.Sanitize(input)

	return sanitizedInput
}
```

#### å¯¹å¾—åˆ°çš„ç»“æœè¿›è¡Œæ’åº

åˆ›å»ºå¯¹åº”çš„ç»“æ„ä½“åå®ç° `sort.Interface` æ¥å£ï¼šè¯¥æ¥å£åŒ…æ‹¬ä¸‰ä¸ªæ–¹æ³•ï¼š`Len()`ã€`Less(i, j int)` å’Œ `Swap(i, j int)`ã€‚

```go
type Search struct {
	Textid int
	Weight int
	Text   Text
}

type ByWeight []Search

func (w ByWeight) Len() int {
	return len(w)
}

func (w ByWeight) Less(i, j int) bool {
	return w[i].Weight > w[j].Weight
}

func (w ByWeight) Swap(i, j int) {
	w[i], w[j] = w[j], w[i]
}

// è°ƒç”¨
sort.Sort(models.ByWeight(res))
```



## dao

å‡½æ•°çš„ä¸€äº›å‘½åè§„å¾‹ï¼š`Get/Del/Update/CreateXxxxByXxx`ã€

### ç»“æ„ä½“

æ•°æ®åº“è¡¨ï¼š

- goè‡ªåŠ¨åˆ›å»ºï¼šæ·»åŠ  `gorm.Model`
- è‡ªå·±åˆ›å»ºäº†è¡¨å¯ä»¥å°†è¡¨çš„sqlè¯­å¥ç»™gptï¼Œç”Ÿæˆå¯¹åº”çš„ç»“æ„ä½“

å­—æ®µæ³¨é‡Šï¼š

- ä½¿ç”¨jsonï¼šegï¼šPhone    string \`json:"phone"\`ï¼ˆæ³¨æ„å¤§å†™ï¼‰

  æ­¤å¤–ï¼Œä»è¯·æ±‚ä½“ä¸­è·å–æ•°æ®ä¹Ÿä¸€å®šè¦å®šä¹‰ç»“æ„ä½“ä½¿å…¶å¯¹åº”

- æ ‡è¯†æ•°æ®åº“ä¸­çš„å­—æ®µåå’Œå­—æ®µç±»å‹ï¼šegï¼šFollowed string  \`gorm:"type:int;column:followed"`

- ä¸å¯ç¼ºå¤±å¦åˆ™æŠ¥é”™çš„é‡è¦æ•°æ®ï¼š`valid:"Required;MaxSize(50)"` ä¸ `ok,_:=valid.Valid(&a)` é…åˆä½¿ç”¨

- æ•°æ®åº“è¡¨ä¸­ä¸å­˜åœ¨çš„å­—æ®µï¼šFullName  string `gorm:"-"` // å¿½ç•¥è¿™ä¸ªå­—æ®µ

### å¢ / åˆ 

åˆ›å»ºï¼š

ä»¥userä¸ºä¾‹ï¼Œåœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼ å…¥å¿…è¦çš„å‚æ•°ï¼Œå¹¶è¡¥å……éƒ¨åˆ†å­—æ®µã€‚å¹¶ä¸”åªèƒ½ä½¿ç”¨createæ–¹æ³•æ‰èƒ½æ’å…¥è®°å½•

```go
func CreateUser(username, phone, sno, special, pwd string) (error, User) {
	salt, _ := utils2.GenerateSalt(8)
	u := User{
		Username:   username,
		Phone:      phone,
		Sno:        sno,
		Special:    special,
		Pwd:        utils2.Md5Encrypt(pwd + salt),
		Salt:       salt,
		UpdateTime: utils2.GetLocalTime(),
	}
	result := utils2.DB.Model(&User{}).Create(&u)
	return result.Error, u
}
```

åˆ é™¤ï¼š

éœ€è¦åœ¨deleteå‰æŒ‡å®šæ¡ä»¶ã€‚

æ ¹æ®tidåˆ é™¤textè¡¨ä¸­çš„æ•°æ®ï¼Œæ ¹æ®RowsAffectedåˆ¤æ–­æ˜¯å¦åˆ é™¤æˆåŠŸã€‚

1. æ ¹æ®ä¸»é”®åˆ é™¤ï¼Œç›´æ¥åœ¨deleteçš„ç»‘å®šç»“æ„ä½“åä½œä¸ºå‚æ•°ä¼ å…¥

   ```go
   func DelTextById(tid int) bool {
   	return utils.DB.Delete(&Text{}, tid).RowsAffected == 1
   }
   ```

2. å…¶ä»–æ¡ä»¶ï¼š

   1. è‡ªå·±å†™åˆ é™¤çš„sqlè¯­å¥

      ```go
      DB.Exec("DELETE FROM imgs WHERE src = ?", src).Delete(&Img{}).Error
      ```

   2. 

      ```go
      return DB.Where("src = ?", src).Delete(&Img{}).Error
      ```

**RowsAffectedçš„ä½¿ç”¨**

å¯¹è¡¨çš„ä¿®æ”¹ã€æ·»åŠ å’Œåˆ é™¤å¯ä»¥è¿”å›boolå€¼ï¼Œå³åˆ¤æ–­ `RowsAffected` æ˜¯å¦ä¸º1ï¼ŒæŠ›å‡ºå¼‚å¸¸ä¹Ÿæ˜¯ä¸€ç§å¤„ç†æ–¹å¼ï¼Œä½†å½±å“è¡Œæ•°çš„åˆ¤æ–­æ›´ä¸ºç›´æ¥

è€Œ`RowsAffected` èƒ½å¦åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ï¼Ÿ

åœ¨æŸ¥æ‰¾ä¸­ä½¿ç”¨çš„æ˜¯ `Find` æ–¹æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œ`RowsAffected` å¹¶ä¸é€‚ç”¨äºåˆ¤æ–­æŸ¥è¯¢ç»“æœæ˜¯å¦ä¸ºç©ºã€‚å› ä¸º `RowsAffected` æ˜¯ç”¨äºè·å–å—å½±å“çš„è¡Œæ•°ï¼Œè€Œä¸æ˜¯è¿”å›çš„è®°å½•æ•°ã€‚

`RowsAffected` åœ¨æ›´æ–°ã€æ’å…¥æˆ–åˆ é™¤æ“ä½œåéå¸¸æœ‰ç”¨ï¼Œä»¥ç¡®å®šæ•°æ®åº“ä¸­å—å½±å“çš„è¡Œæ•°ã€‚ä½†å¯¹äºæŸ¥è¯¢æ“ä½œï¼Œè¿”å›çš„æ˜¯æŸ¥è¯¢ç»“æœé›†åˆ‡ç‰‡ï¼Œè€Œéå—å½±å“çš„è¡Œæ•°ã€‚

å¯¹åº”++ -- çš„å­—æ®µï¼Œç¼–å†™äº†æ–¹æ³•ï¼ˆæ ¹æ®idå¯¹è¯¥è®°å½•çš„å­—æ®µè¿›è¡ŒåŠ å‡ï¼‰è¿›è¡Œå¯¹åº”çš„è¡¨æ“ä½œ

```go
func IncrementField(table, field string, id int) error {
	return utils.DB.Table(table).
		Where("id = ?", id).UpdateColumn(field, gorm.Expr(field+" + ?", 1)).Error
}

func DecrementField(table, field string, id int) error {
	return utils.DB.Table(table).
		Where("id = ?", id).UpdateColumn(field, gorm.Expr(field+" - ?", 1)).Error
}
```

è€Œéœ€è¦ä¼ å…¥çš„è¡¨åã€å­—æ®µåç§°åˆ™è®¾ç½®äº†å¯¹åº”çš„å¸¸é‡

```go
const (
	TableUsers   = "users"
	TableComment = "comments"
	TableText    = "texts"

	UserFieldFanNum    = "fan_num"
	UserFieldFollowNum = "follow_num"

	TextFieldView    = "view"
	TextFieldLike    = "likes"
	TextFieldCollect = "collect"
	TextFieldComment = "comment"

	CommentFieldReplied     = "replied"
)
```

### æŸ¥

åœ¨ä½¿ç”¨ `Find` è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªç»“æœé›†åˆ‡ç‰‡ï¼Œå³ä½¿æ²¡æœ‰åŒ¹é…çš„è®°å½•ï¼Œä¹Ÿä¼šè¿”å›ä¸€ä¸ª**ç©ºåˆ‡ç‰‡**ï¼ˆä¸æ˜¯nilï¼‰è€Œä¸æ˜¯ `RecordNotFound` é”™è¯¯ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ `Find` è¿›è¡ŒæŸ¥è¯¢åï¼Œéœ€è¦æ‰‹åŠ¨åˆ¤æ–­ç»“æœé›†åˆ‡ç‰‡çš„é•¿åº¦æ¥ç¡®å®šæŸ¥è¯¢ç»“æœæ˜¯å¦ä¸ºç©ºã€‚

å…³äº`.Where`:

- å‚æ•°ä¼ å…¥é€»è¾‘ç±»ä¼¼äºï¼š`db.Where("condition1 = ? AND condition2 = ?", value1, value2)`ï¼Œä¸æ”¯æŒ`utils.DB.Where("user = ?", uid, "text = ?", tid)`
- å¹¶ä¸”å¯¹äºæ¨¡ç³ŠæŸ¥è¯¢ï¼š`.Where("username LIKE ", "%"+name+"%")`

å­˜åœ¨æ€§åˆ¤æ–­ï¼š

```go
result := db.First(&user)
result.RowsAffected // è¿”å›æ‰¾åˆ°çš„è®°å½•æ•°
	return errors.Is(result.Error, gorm.ErrRecordNotFound)	// limit 1 && not record ==> ErrRecordNotFound

result.Error        // returns error o nil
```



# å•å…ƒæµ‹è¯•

æ³¨æ„æ–‡ä»¶éœ€è¦ä»¥ `_test.go` ç»“å°¾ï¼Œæ–¹æ³•éœ€è¦åŠ `Test` å¼€å¤´ï¼Œåç»­ä½¿ç”¨é©¼å³°å‘½åæ³•æˆ–è€…ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”

## 1ã€tokenæµ‹è¯•

ä½¿ç”¨ `goconvey` æ¡†æ¶è¿›è¡Œæµ‹è¯•

1. å£°æ˜ï¼šåœ¨ç¬¬ä¸€ä¸ªconveyä¸­è®¾ç½®tokenå¹¶å£°æ˜è·¯ç”±ï¼Œç¼–å†™è·¯ç”±çš„å¤„ç†å‡½æ•°ï¼ˆæå–ä»¤ç‰Œï¼‰
2. è°ƒç”¨ï¼šåœ¨ç¬¬äºŒä¸ªconveyä¸­è®¾ç½®è°ƒç”¨api
3. éªŒè¯ï¼šç¬¬ä¸‰ä¸ªconveyä¸­è¿›è¡Œå“åº”ç å’Œuesridçš„éªŒè¯

åœ¨è®¾ç½®tokençš„éƒ¨åˆ†æˆ‘åˆ›å»ºäº†æˆ‘çš„tokenï¼Œäºæ˜¯ç›´æ¥å°†è®¾ç½®tokençš„ä»£ç è´´è¿‡æ¥äº†ã€‚è®¾ç½®å®Œtokenåä»»æ„é€‰æ‹©éœ€è¦è¿›è¡Œç™»å½•éªŒè¯çš„è·¯ç”±ï¼Œåœ¨è¿™é‡Œé‡æ–°ç¼–å†™å¤„ç†å‡½æ•°ï¼Œä½†åªéœ€è¦æå‰ä»¤ç‰Œè§£æä»¤ç‰Œã€‚

åœ¨ç¬¬äºŒä¸ªconveyä¸­æ¨¡æ‹Ÿè¯·æ±‚

```go
w := httptest.NewRecorder()	// åˆ›å»ºè™šæ‹Ÿå“åº”è®°å½•å™¨
req, _ := http.NewRequest("POST", "/user/head", nil)	// è™šæ‹Ÿçš„è¯·æ±‚å¯¹è±¡ï¼Œè¯·æ±‚ç±»å‹ è·¯ç”± è¯·æ±‚ä¸»ä½“
// æ·»åŠ æµ‹è¯•ä»¤ç‰Œåˆ°è¯·æ±‚å¤´
req.Header.Set("Authorization", token)
router.ServeHTTP(w, req)	// è°ƒç”¨è¦æµ‹è¯•çš„å¤„ç†å‡½æ•°
```

å®Œæ•´çš„tokenæµ‹è¯•ä»£ç ï¼š

```go
func TestUserIDFromToken(t *testing.T) {
	var userID int
	Convey("Given a valid token", t, func() {
		claims := common.Claims{
			Userid: 10,
			StandardClaims: jwt.StandardClaims{
				// è¿‡æœŸæ—¶é—´
				ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(),
				// æŒ‡å®štokenå‘è¡Œäºº
				Issuer: "xinye_2022",
			},
		}
		token, _ := jwt.NewWithClaims(jwt.SigningMethodHS256, claims).SignedString([]byte(key))

		router := gin.Default()
		router.POST("/user/head", func(c *gin.Context) {
			// ä»è¯·æ±‚å¤´ä¸­æå–ä»¤ç‰Œ
			token := c.Request.Header.Get("Authorization")
			// è§£æä»¤ç‰Œï¼Œè·å–ç”¨æˆ·ID
			userID = extractUserIDFromToken(token)
		})

		Convey("When calling the API with the token", func() {
			w := httptest.NewRecorder()
			req, _ := http.NewRequest("POST", "/user/head", nil)
			// æ·»åŠ æµ‹è¯•ä»¤ç‰Œåˆ°è¯·æ±‚å¤´
			req.Header.Set("Authorization", token)

			router.ServeHTTP(w, req)

			Convey("The user ID should be extracted correctly", func() {
				So(w.Code, ShouldEqual, http.StatusOK)
				So(userID, ShouldEqual, 10)
			})
		})
	})
}

func extractUserIDFromToken(token string) int {
	claims, _ := common.ParseToken(token)
	return claims.Userid
}
```


